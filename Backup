#!/bin/bash

# ==========================
# Backup + Restore Bot Script
# ==========================

# Warna
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
NC='\033[0m'

# Variabel
DATE=$(date +"%Y-%m-%d")
MYIP=$(curl -s ipv4.icanhazip.com)
SCRIPT_PATH=$(realpath "$0")
SCRIPT_NAME=$(basename "$SCRIPT_PATH")
BACKUP_DIR="/root/backup"
LOG_FILE="/var/log/backup-bot.log"

# Fungsi log
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
    echo "[INFO] $(date '+%Y-%m-%d %H:%M:%S') $1" >> $LOG_FILE
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
    echo "[ERROR] $(date '+%Y-%m-%d %H:%M:%S') $1" >> $LOG_FILE
}

# Setup Bot
setup_bot() {
    echo "Pergi ke @BotFather untuk buat BOT."
    echo "Pergi ke @MissRose_bot buat cek ID kamu."
    echo ""
    read -p "Masukkan Bot Token: " bottoken
    read -p "Masukkan Admin ID : " adminid
    echo "$bottoken" > /root/.bckupbot
    echo "$adminid" >> /root/.bckupbot
    log_info "Setup Bot selesai."
}

# Backup data
bot_backup() {
    # Load bot token dan admin id
    bottoken=$(sed -n '1p' /root/.bckupbot)
    adminid=$(sed -n '2p' /root/.bckupbot)

    mkdir -p "$BACKUP_DIR"

    echo ""
    echo "Membuat password backup..."
    read -t 10 -p "Password backup (default pakyavpnxbackdoor): " InputPass
    [[ -z $InputPass ]] && InputPass="pakyavpnxbackdoor"

    # Copy data penting
    cp /etc/passwd $BACKUP_DIR/ 2>/dev/null
    cp /etc/group $BACKUP_DIR/ 2>/dev/null
    cp /etc/shadow $BACKUP_DIR/ 2>/dev/null
    cp /etc/gshadow $BACKUP_DIR/ 2>/dev/null
    cp -r /etc/xray $BACKUP_DIR/xray 2>/dev/null
    cp -r /var/www/html $BACKUP_DIR/html 2>/dev/null
    cp -r /var/lib/kyt $BACKUP_DIR/kyt 2>/dev/null

    cd /root
    ZIP_FILE="backup-$MYIP-$DATE.zip"
    zip -rP "$InputPass" "$ZIP_FILE" backup >/dev/null 2>&1

    log_info "Backup dibuat: $ZIP_FILE"

    # Kirim file ke Telegram
    log_info "Mengirim backup ke Telegram..."

    response=$(curl -s -F "chat_id=${adminid}" -F "document=@${ZIP_FILE}" "https://api.telegram.org/bot${bottoken}/sendDocument")

    # Cek response
    file_id=$(echo "$response" | grep -o '"file_id":"[^"]*"' | head -1 | cut -d'"' -f4)

    if [[ -n "$file_id" ]]; then
        log_info "Backup sukses terkirim!"
        echo -e "${YELLOW}File ID:${NC} $file_id"

        # Dapatkan file_path dari file_id
        file_info=$(curl -s "https://api.telegram.org/bot${bottoken}/getFile?file_id=${file_id}")
        file_path=$(echo "$file_info" | grep -o '"file_path":"[^"]*"' | cut -d'"' -f4)

        if [[ -n "$file_path" ]]; then
            log_info "File Path berhasil diambil!"
            echo -e "${YELLOW}File Path:${NC} $file_path"
            echo ""
            echo -e "${GREEN}✅ Backup Sukses${NC}"
            echo -e "Gunakan File ID dan Path ini saat restore:"
            echo "FILE ID  : $file_id"
            echo "FILE PATH: $file_path"
        else
            log_error "Gagal mengambil file_path dari Telegram."
        fi
    else
        log_error "Gagal mengirim file backup ke Telegram."
        echo "Response dari Telegram: $response"
    fi

    # Bersih-bersih
    rm -rf /root/backup
    rm -f "/root/$ZIP_FILE"
}

# Restore data
bot_restore() {
    bottoken=$(sed -n '1p' /root/.bckupbot)

    read -p "Masukkan File ID  : " file_id
    read -p "Masukkan File PATH : " file_path
    read -p "Masukkan Password  : " InputPass

    log_info "Mendownload file dari Telegram..."

    curl -s -o /root/backup.zip "https://api.telegram.org/file/bot${bottoken}/${file_path}"

    unzip -P "$InputPass" /root/backup.zip -d /root/backup >/dev/null 2>&1

    log_info "Restore data VPS..."

    cp /root/backup/passwd /etc/ 2>/dev/null
    cp /root/backup/group /etc/ 2>/dev/null
    cp /root/backup/shadow /etc/ 2>/dev/null
    cp /root/backup/gshadow /etc/ 2>/dev/null
    cp -r /root/backup/xray /etc/ 2>/dev/null
    cp -r /root/backup/html /var/www/ 2>/dev/null
    cp -r /root/backup/kyt /var/lib/ 2>/dev/null

    rm -rf /root/backup
    rm -f /root/backup.zip

    log_info "Restore selesai!"
}

# Menu utama
main_menu() {
    clear
    echo -e "${BLUE}╭═════════════════════════════════════╮${NC}"
    echo -e "${BLUE}│        Backup Bot by ChatGPT         │${NC}"
    echo -e "${BLUE}╰═════════════════════════════════════╯${NC}"
    echo ""
    echo "1. Setup Bot Telegram"
    echo "2. Backup Data ke Telegram"
    echo "3. Restore Data dari Telegram"
    echo "4. Keluar"
    echo ""
    read -p "Pilih Menu [1-4]: " menu

    case $menu in
        1) clear; setup_bot ;;
        2) clear; bot_backup ;;
        3) clear; bot_restore ;;
        4) exit 0 ;;
        *) main_menu ;;
    esac
}

# Start
clear
if [[ ! -f /root/.bckupbot ]]; then
    echo "Bot belum disetup."
    setup_bot
fi
main_menu
